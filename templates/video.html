{% extends 'base.html' %}

{% block styling %}
<style>
    body {
        margin-bottom: 3rem;
    }

    video {
        margin-top: 10vh;
    }

    .info {
        color: #7f7f7f;
        display: flex;
        justify-content: space-between;
    }

    .info>p {
        margin-top: 0;
    }

    h1 {
        margin-bottom: 0.75rem;
    }

    canvas {
        width: 50vw;
    }

    #description {
        font-size: 0.9rem;
    }

    video,
    h1,
    #description,
    .info {
        width: 60vw;
    }

    @media screen and (max-width: 850px) {

        video,
        h1,
        canvas,
        #description,
        .info {
            width: 80vw;
        }
    }

    .download {
        text-decoration: none;
        color: inherit;
    }

    .spacer {
        margin-left: 0.5rem;
        margin-right: 0.5rem;
    }

    .metadata {
        display: none;
        color: #595959;
        margin-left: 1rem;
        line-height: 0.65rem;
        margin-bottom: 0.65rem;
        /* TODO: fix line height */
    }
</style>
{% endblock %}

{% block content %}
<div id="content">
    <!-- Video -->
    <video src="/archive/{{ video.channel.path }}/videos/{{ video.id }}.mp4" autoplay controls></video>
    <!-- Information -->
    <h1>{{ video.title.current() }}</h1>
    <div class="info">
        {% set views = video.views.current() %}
        <p>
            {{ views }} view{% if views != 1 %}s{% endif %}
            <span class="spacer">‚Ä¢</span>
            {{ video.uploaded.strftime("%d/%m/%Y") }}
        </p>
        <p>
            <a href="/archive/{{ video.channel.path }}/videos/{{ video.id }}.mp4" class="download" download>üìã</a>
            <span class="spacer">‚Ä¢</span>
            {% set likes = video.likes.current() %}
            üëç {{ likes }}
        </p>
    </div>
    <!-- Description -->
    {% set description = video.description.current().split("\n") %}
    {% if description|count != 1 and description[0] != "" %}
    <button onclick="toggleDescription('description', 'description', this)">Hide description</button>
    <p id="description">
        {% for line in description %}
        {{ line }}<br />
        {% endfor %}
    </p>
    {% endif %}
    <!-- History -->
    <h2>History</h2>
    {% set mto_title = video.title.inner|count != 1 %}
    {% set mto_description = video.description.inner|count != 1 %}
    <ul>
        {% if not mto_title and not mto_description %}
        <li>No title or description changes on record</li>
        {% else %}
        {% if mto_title %}
        {% for timestamp in video.title.inner %}
        <li>
            Title changed from
            <button onclick="toggleButton('history_title' + {{ loop.index }}, 'title', this)">
                Show title
            </button>
            at {{ timestamp }}
            <span id="history_title{{ loop.index }}" class="metadata">
                <br />{{ video.title.inner[timestamp] }}
            </span>
        </li>
        {% endfor %}
        {% else %}
        <li>No title changes on record</li>
        {% endif %}
        {% if mto_description %}
        {% for timestamp in video.description.inner %}
        <li>
            Description changed from
            <button onclick="toggleButton('history_description' + {{ loop.index }}, 'description', this)">
                Show description
            </button>
            at {{ timestamp }}
            <span id="history_description{{ loop.index }}" class="metadata">
                <br />
                {% for line in video.description.inner[timestamp].split("\n") %}
                {{ line }}<br />
                {% endfor %}
            </span>
        </li>
        {% endfor %}
        {% else %}
        <li>No description changes on record</li>
        {% endif %}
        {% endif %}
    </ul>
    <!-- Graphs -->
    {% set mto_views = video.views.inner|count != 1 %}
    {% set mto_likes = video.likes.inner|count != 1 %}
    {% if mto_views or mto_likes %}
    {% if mto_views %}
    <h2>Views over time</h2>
    <canvas id="chart_views"></canvas>
    {% endif %}
    {% if mto_likes %}
    <h2>Likes over time</h2>
    <canvas id="chart_likes"></canvas>
    {% endif %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        function chart(type, id, data) {
            // Generate config
            const points = {
                labels: Object.keys(data),
                datasets: [{
                    label: "# of " + type,
                    data: Object.values(data),
                    fill: false,
                    borderColor: "rgb(75, 192, 192)",
                    tension: 0.1
                }]
            };

            // Get context
            const ctx = document.getElementById(id).getContext("2d");

            // Create chart
            return new Chart(ctx, {
                type: "line",
                data: points,
                options: { responsive: false }
            })
        }

        // Get data
        let views_data = {{ views_data| safe }};
        let likes_data = {{ likes_data| safe }};

        // Create charts
        if (Object.keys(views_data).length != 1) {
            chart("Views", "chart_views", views_data);
        }
        if (Object.keys(likes_data).length != 1) {
            chart("Likes", "chart_likes", likes_data);
        }
    </script>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // TODO: fixs
    function toggleButton(id, name, caller) {
        let desc = document.getElementById(id);
        if (desc.style.display === "none") {
            caller.innerText = "Hide " + name;
            desc.style.display = "block";
        } else {
            caller.innerText = "Show " + name;
            desc.style.display = "none";
        }
    }
</script>
{% endblock %}